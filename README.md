# rninecraft

## ゲーム概要

- Tarkov系の脱出リスクとローグライクの成長を掛け合わせた、2DトップダウンRPG。
- シードベースのワールドに潜り、収集・合成・強化で装備を育て、脱出成功で持ち帰る。

### ゲームの流れ

1. 基本的に拠点と、ゲームプレイの2つに分かれる
2. 拠点では倉庫にアイテムを保管したり、アイテムを売却したり、アイテムの合成や強化、鍛冶屋でのprefix付与などが可能
3. ゲームプレイではマップに潜り、アイテムを回収したり、敵を倒したり、ミッションをクリアしたりして経験値やアイテムを獲得する
4. マップ内で脱出地点を見つけるか、脱出アイテムを使用することでゲームエンド
5. ゲームエンド後、獲得したアイテムや経験値を確認し、倉庫に保管したり、売却したりできる
6. 上を繰り返して、より強力なアイテム、ステータスを目指す

#### 死亡・脱出時のルール（最小仕様）

- 脱出成功: 取得品を全て持ち帰り、経験値/ゴールド/素材を獲得
- 死亡: インベントリ内のアイテムは原則ロスト（倉庫内は保持）。例外は将来的に「セーフ枠」などで緩和予定
- 脱出アイテム: 使用で即時ゲームエンド（成功扱い）。入手性は低め

### アイテムについて

- アイテムは1*1,2*2などインベントリのマスを圧迫する
  - インベントリのマスは初期状態で20マス(4*5)で、倉庫は100マス(10*10)
  - インベントリや倉庫のマスは拡張可能で、拡張することでより多くのアイテムを保管できる
  - 初期実装では回転は不可（将来的に追加可）
- アイテムはゲーム時点、リザルト時点、倉庫時点で売却が可能
- アイテムはゲーム時点のみで砕くことが可能
  - 砕くことで素材アイテムと経験値、一部アイテムを獲得できる
  - 砕くことで得られる素材アイテムはランダムで、アイテムの数もランダム（レアリティとprefix倍率で変化）
- アイテムのジャンルは武器、聖遺物、道具、素材アイテム、売却専用アイテムに分かれる
  - 武器は二つだけ装備可能で、ステータスを上げる
    - 武器はメイン武器とサブ武器で分けられ、キーで切り替え可能
  - 聖遺物は5つまで装備可能で、ステータスを上げる
    - 特殊効果の聖遺物は別枠として装備可能
      - 別枠の例: バックパック(インベントリ拡張)
  - 道具は使用することで一時的にステータスを上げたり、回復したり、特殊効果を発生したりする
    - 鍵を開けたり、脱出など
  - 素材アイテムは主にアイテムの合成や強化に使用する
  - 売却専用アイテムは売却価格が高く、インベントリ圧迫が少ない
    - 売却専用アイテムはクエストの納品にも使用される
- 同じアイテムは合成でき、suffixに「+1」などが付く
  - suffixによる効果は売却価格の増加(1.3倍など)、耐久度の増加、ステータスの増加など
- アイテムはゲーム中の鍛冶屋でprefixを付与できる
  - prefixによる効果はステータスの増加、特殊効果付与(クリティカル率上昇など)
  - 一部prefixは特定の武器にしか付与できない
- アイテムには耐久度があり、使用することで減少し0になると壊れる
  - 壊れた時点でインベントリから消失し、一部素材アイテムに変化する(入手するアイテムは少ない)
- アイテムは図鑑で確認でき、図鑑を埋めることでボーナスが得られる
  - 図鑑はアイテムを入手することで埋まる
- レアリティが存在していて、レアリティが高いほどステータスや効果が強力になる
  - レアリティはコモン、アンコモン、レア、エピック、レジェンダリー、ミシックの5段階
- アイテムは宝箱やボスドロップで入手可能
  - ボスは倒されると宝箱が出現し、その中にアイテムが入っている

### 魔法石について

- 魔法石は装備に装着することで追加のステータスや効果を得られる特殊なアイテム
- 武器にはグリッドのスロットがあり、様々な形をした魔法石を嵌め込むことで効果を発揮する
- 魔法石の形状はT字型、L字型、I字型などがあり、スロットの形状に合わせて装着する
- グリッドpingの形状やスロット数は武器ごとに異なり、強力な武器ほど多くの魔法石を装着できる
- スロットが一列埋まるとボーナス効果が発動する
  - 同じ属性の魔法石が一列に揃うと追加効果が発動する
- 魔法石は敵ドロップで入手可能で入手時点では1*1の形でインベントリに収納される

### インベントリについて

- インベントリは2Dグリッド形式で表示され、アイテムをドラッグアンドドロップで配置できる
- インベントリのサイズは初期状態で6*6マスで、装備や強化で拡張可能
- インベントリ内のアイテムはドラッグアンドドロップで移動、装備、使用が可能
- インベントリ内のアイテムは右クリックで詳細情報を表示できる
- アイテムが一定範囲の場所を取るので、配置を工夫する必要がある(荷物整理系ゲームの要素)

### ステータスについて

- ステータスはキャラクターの能力を表し、様々な効果を持つ
- statusはhp(実数), hpRegen(割合), Attack(オブジェクト), Defense(オブジェクト), attackSpeed(実数), critRate(割合), critDamage(割合), speed(実数), Evasion(回避), lifesteal(割合), Bonus(石/経験/ゴールド各倍率), itemDropRate(割合)を持つ
- Attackは基本攻撃力(実数)と各種割合(物理/魔法/各属性)を持つ（未指定は0）
- Defenseは基本防御力(実数)と各種割合(全体/物理/魔法/各属性)を持つ
- クリティカル: critRate(%)とcritDamage(%)、敵側の会心防御(%)で最終クリダメを軽減
- buffはstatusの各ものに対して割合と実数による強化を行う(statusを書き換えるのではなく計算式に組み込む)
- buffは%であっても足し算を行う(10(%)+10(%)は11(%)ではなく20(%)とする)
- ステータスはベース、実数値、パーセンテージの3つの形式がある
- ステータスはレベルアップ、アイテム装備、スキル、バフなどで上昇する

#### ダメージ計算

順序を固定し、上限/下限を明示します。

1. `Raw = baseAttack + Σ(flatAttackBuff)`
2. `MultA = Raw × Π(1 + percentAttackBuff_i)`
3. `Elem = Σ_k [ (Raw / 10) × elemRate_k × (1 + elemBonus_k) × elementalMultiplier ]`
4. `Defense = (defBase + Σ(flatDefBuff)) × Π(1 + percentDefBuff_i)`
5. `CritMultiplier = 1 + clamp(critDamage - enemyCritDefense, 0, cap)`
6. `Damage = clamp( (MultA + Elem - Defense) × CritMultiplier × otherMultipliers, 1, +∞ )`

備考: 物理/魔法/属性の「割合バフ」は乗算、同種バフ同士は加算。クリ率は事前判定、回避成功時は0ダメージ（i-frame中は重複ヒット無効）。

### レベルアップについて

- 経験値が一定値に達するとレベルアップする
- 経験値は敵を倒す、ミッションをクリアする、アイテムを砕くなどで獲得できる
- レベルアップ時に3つの選択肢から1つを選び、ステータスやスキルを強化できる
- 選択肢はランダムで生成され、同じ選択肢が出ることもある
- 武器によって比率や選択肢の内容が変化する

補足: 候補は「カテゴリごとの重み付け＋現在装備のタグ補正」で抽選（重複は許容、最大スタックは各効果ごとに上限設定）。

### 攻撃、スキルについて

- 物理攻撃と属性攻撃に分かれる
- 詳細な式は「ダメージ計算」セクションを参照
- 属性攻撃はこのゲームにおいて追加ダメージのことを指す
  - 魔法の遠距離は物理が0で、魔法ダメージのみを与える攻撃
- スキルは攻撃ターゲットを定める関数としての役割を持つ
  - スキルは攻撃の前に発動し、攻撃対象を決定する
  - スキルには範囲や効果が設定されていて、返り値に攻撃する相手と追加効果、クールダウンなどを含む
- スキルは敵味方関係なく発動するものであり、やろうと思えば敵のスキルも発動できる
  - 近接単体などもスキルとして扱う
- スキルにはクールタイムが存在し、連続で使用することはできない

補足:

- 「通常攻撃」という独立概念は存在せず、"Basic"（仮）などのスキルとして実装される（自動発動）。
- 攻撃速度は「影響を受ける」フラグを持つスキルのクールダウン短縮に作用する（Basicは既定で対象）。
- それ以外のスキルは個別クールダウンのみで、攻撃速度の影響は受けない想定（将来フラグで切替可能）。

### マップについて

- マップはシード値に基づいて生成され、毎回異なる構造になる
- 基本的に無限に広がるマップを想定している
- 基本的にゲームに再出発しても同じシードで同じマップが生成される(新しく設定などは可能)
- マップには様々な構造物が生成され、探索要素が存在している
- 構造物は2次元配列で表現され、各マスに建物や障害物、アイテム、敵などが配置される
  - ブロックはマイクラのように四角く表現される
  - ブロックは単色で表現され、詳細なテクスチャは存在しない
- プレイヤーはマップ内を自由に移動でき、アイテムを回収したり、敵と戦ったり、ミッションを納品したりできる
- マップは2Dのトップダウンビューで表示される
- プレイヤーは画面中央に固定され、マップが移動する形式で表示される
- マップにはバイオームが存在し、バイオームごとに出現する敵やアイテム、構造物が異なる
- データ構造はタイルマップ形式を採用し、各タイルに情報を持たせる

補足: マップはチャンク(例: 16x16セル)の集合。チャンクはシード＋座標で決定生成し、viewDistance内をロード、cacheDistance外はアンロード。

#### チャンクロードのゲーム的な挙動

- プレイヤーの周囲には「計算されている世界」と「忘れられつつある世界」の2つの距離帯が存在するイメージで処理される
  - 演算距離: この距離内のチャンクは常にゲームロジックの対象となり、新しく踏み込んだ方向にはその都度チャンクが生成される
  - アンロード距離: 演算距離よりも一段広い範囲を越えたチャンクは、徐々にワールドから外れていき、処理負荷の対象から外れる
- 処理の流れは「プレイヤーの移動に合わせて、必要なチャンクだけをキューに積み替える」イメージに近い
  - 新しく演算距離に入ったチャンクは「ロードキュー」に積まれ、少しずつ生成・復帰される
  - 演算距離から十分に離れたチャンクは「アンロードキュー」に積まれ、視界の外で静かに消えていく
  - 一度生成されたチャンクは「記憶」として保持されており、再び近づいたときには同じ地形・構造物で復帰する
- プレイヤー視点では、常に自分の周囲だけが生きていて、遠くの世界は凍結されているような感覚になる
  - これにより、マップは理論上ほぼ無限に広がりつつも、プレイフィールとしては滑らかなスクロールと探索を両立できる

### 戦闘について

- 敵はマップ内にランダムに配置されている
- 敵はランダムウォークで移動し、プレイヤーを発見すると追跡して攻撃してくる(一定範囲までしか追跡しない)
- 戦闘はヴァンパイアサバイバーズのようにスキル（Basic含む）の自動発動で進行する
- プレイヤーは移動とスキル発動のみを操作する

補足: 探知→追跡→攻撃のAI段階を持ち、追跡は一定距離で打ち切り。近接/遠隔/ボスは個別スキルを持つ。

### 拠点などゲーム外について

- 拠点はゲーム外での操作が可能なエリア
- 拠点では倉庫管理、アイテム売却、アイテム合成、強化、鍛冶屋でのprefix付与などが可能
- 拠点ではクエストの受注、納品が可能
- 拠点ではキャラクターのステータス確認、装備変更が可能
- 拠点では図鑑の確認が可能
- 拠点では設定変更、セーブ、ロードが可能

## システム要件

### ライブラリ

- TypeScriptのみ
- ReactやThree.jsなどのライブラリは使用しない
- 描画は自作のjsxを使う(divのみ)

### ロジック

- ゲームロジックは純粋なTypeScriptで実装し、描画やUIとは分離する
- ECSパターンを採用し、エンティティ、コンポーネント、システムに分けて実装する
- ゲームループはrequestAnimationFrameを使用し、固定タイムステップ（例: 16.666ms）で更新する（補間描画）
- ゲームデータはJSON形式で保存し、ロード可能にする(シリアライズし軽く暗号化する)
- コードは関数型プログラミングを基本とし、副作用を最小限に抑える

### セーブ/ロード

- 保存スナップショットには`version`, `seed`, `rngState`, `player`, `inventory`, `storage`, `quests`, `worldMeta(viewDistance/cacheDistance)`を含む
- バージョンは後方互換のため明記し、必要に応じてマイグレーションを行う
- RNGの状態を保存し、同一シードでの再現性を確保

### デザインイメージ

- デザインはネオン * 近未来のような感じ(TRON風のような)
- 色はバイオームによって変化し、全体的に明るめの色調
- UIは左上にHPなどのステータスバー、右上にミニマップ、左下にスキル、武器切り替えを配置
